<?xml version="1.0"?>
<project name="deps" basedir="../" xmlns:artifact="urn:maven-artifact-ant">

    <property name="webapp.dir" value="../flies-web"/>
    <property name="webapp.lib.dir" value="${webapp.dir}/lib"/>
	
    <property name="webapp.test.dir" value="../flies-web-test"/>
    <property name="webapp.test.lib.dir" value="${webapp.test.dir}/lib"/>

    <property name="build.dir" value="build-tools"/>
    <property name="build.lib.dir" value="${build.dir}/lib"/>
    
	<!--
	<property name="maven.repo.local" value="/tmp/m2"/>
	-->
	
    <condition property="maven.repo.local" value="${maven.repo.local}" else="${user.home}/.m2/repository">  
      <isset property="maven.repo.local"/>  
    </condition>  
	
    <!-- Fetch Maven Ant Tasks jar: -->
    <property name="maven.version" value="2.0.9" />
    <property name="maven-artifact-ant.bootstrap.jar" location="${build.lib.dir}/maven-ant-tasks-${maven.version}.jar" />
    <property name="remoteRepo" value="" />

    <target name="-check-get-maven-artifact-ant">
        <available property="-get-maven-artifact-ant-done" file="${maven-artifact-ant.bootstrap.jar}" />
    </target>

    <target name="-get-maven-artifact-ant" depends="-check-get-maven-artifact-ant" unless="-get-maven-artifact-ant-done">
        <mkdir dir="${build.lib.dir}" />
        <get 
        	src="http://repository.jboss.com/maven2/org/apache/maven/maven-ant-tasks/${maven.version}/maven-ant-tasks-${maven.version}.jar" 
        	dest="${maven-artifact-ant.bootstrap.jar}" 
            usetimestamp="true" />
    </target>

    <target name="-initTaskDefs" depends="-get-maven-artifact-ant">
        <path id="maven-ant-tasks.classpath" 
        	path="${maven-artifact-ant.bootstrap.jar}" />
        <typedef resource="org/apache/maven/artifact/ant/antlib.xml" 
        	uri="urn:maven-artifact-ant" 
        	classpathref="maven-ant-tasks.classpath" />
    </target>
	
    <target name="-init-deps">
        <available property="deps.installed" value="true" file="${webapp.lib.dir}/flies-deps-${deps.version}" type="file"/>
        <uptodate 
            property="mavenuptodate" 
            srcfile="pom.xml"
            targetfile="${webapp.lib.dir}/.maven-deps-timestamp"> 
        </uptodate>
    </target>
	
	
    <target name="download-deps" depends="-init-deps" unless="mavenuptodate"
           description="Download all dependencies (unless already fetched)">
        <antcall target="download-deps-force" />
    </target>	
	
    <target name="download-deps-force" depends="download-webapp-deps,download-test-deps"
 	   description="Download all dependencies (Will check for snapshot updates)"/>
	
   	<target name="download-webapp-deps" depends="-initTaskDefs" 
	   description="Download Web app dependencies">

        <mkdir dir="${webapp.lib.dir}" />

   	    <artifact:localRepository id="local.repository" path="${maven.repo.local}"/>

   		<artifact:pom file="${build.dir}/pom.xml" id="maven.project" />

        <artifact:dependencies 
           filesetId="dependency.fileset" 
           pathId="dependency.classpath" 
           versionsId="dependency.versions"
           useScope="compile" 
           type="jar"
           settingsfile="${build.dir}/maven-settings.xml">
            <pom refid="maven.project" />
            <localRepository refid="local.repository"/>
        </artifact:dependencies>

    	<!-- This mapper strips version number from directory path and filename -->
        <copy todir="${webapp.lib.dir}">
    	  <fileset refid="dependency.fileset" />
    	  <mapper classpathref="maven-ant-tasks.classpath"
    	          classname="org.apache.maven.artifact.ant.VersionMapper"
    	          from="${dependency.versions}" 
    	          to="flatten" />
    	</copy>
    	
        <touch file="${webapp.lib.dir}/.maven-deps-timestamp" />
    	
    </target>
	
   	<target name="download-webapp-deps-source" depends="-initTaskDefs" 
	   description="Download sources for Web app dependencies">

        <mkdir dir="${webapp.lib.dir}/src" />

   	    <artifact:localRepository id="local.repository" path="${maven.repo.local}"/>

        <artifact:pom file="${build.dir}/pom.xml" id="maven.project" />

        <artifact:dependencies 
           sourcesfilesetId="dependencySources.fileset" 
           pathId="dependency.classpath" 
           versionsId="dependency.versions"
           useScope="compile" 
           type="jar"
           settingsfile="${build.dir}/maven-settings.xml">
            <pom refid="maven.project" />
            <localRepository refid="local.repository"/>
        </artifact:dependencies>

    	<!-- This mapper strips version number from directory path and filename -->
        <copy todir="${webapp.lib.dir}/src">
    	  <fileset refid="dependencySources.fileset" />
    	  <mapper classpathref="maven-ant-tasks.classpath"
    	          classname="org.apache.maven.artifact.ant.VersionMapper"
    	          from="${dependency.versions}" 
    	          to="flatten" />
    	</copy>
    	
        <touch file="${webapp.lib.dir}/.maven-deps-timestamp" />
    	
    </target>

    <target name="download-test-deps" depends="-initTaskDefs" 
    	   description="Download Test dependencies">

    	<mkdir dir="${webapp.test.lib.dir}" />
    	
   	    <artifact:localRepository id="local.repository" path="${maven.repo.local}"/>

        <artifact:pom file="${build.dir}/test-pom.xml" id="maven.project" />

        <artifact:dependencies 
           filesetId="dependency.test.fileset" 
           pathId="dependency.test.classpath" 
           versionsId="dependency.test.versions"
           useScope="embedded" 
           type="jar"
           settingsfile="${build.dir}/maven-settings.xml">
        	<!-- sourcesFilesetId="dependency.test.sourcesFileset" -->
            <pom refid="maven.project" />
            <localRepository refid="local.repository"/>
        </artifact:dependencies>
        <copy todir="${webapp.test.lib.dir}">
          <fileset refid="dependency.test.fileset" />
          <mapper classpathref="maven-ant-tasks.classpath"
                  classname="org.apache.maven.artifact.ant.VersionMapper"
                  from="${dependency.test.versions}" 
                  to="flatten" />
        </copy>

        <touch file="${webapp.test.lib.dir}/.maven-deps-timestamp" />
    	
    </target>
	
</project>